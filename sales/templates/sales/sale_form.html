{% extends 'base.html' %}
{% load form_tags %}

{% block title %}New Sale Transaction{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">New Sale Transaction</h1>
    
    <form method="post" id="sale-form">
        {% csrf_token %}

        <div class="border-b pb-4 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">Customer & Payment</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">{{ sale_form.customer.label }}</label>
                    {{ sale_form.customer }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">{{ sale_form.payment_type.label }}</label>
                    <div class="mt-2 space-x-4 flex items-center">
                        {% for choice in sale_form.payment_type %}
                            <label class="inline-flex items-center">
                                <input type="radio" name="{{ sale_form.payment_type.name }}" value="{{ choice.choice_value }}" {% if choice.is_checked %}checked{% endif %} id="{{ choice.id_for_label }}" class="focus:ring-primary-blue h-4 w-4 text-primary-blue border-gray-300 payment-type-radio">
                                <span class="ml-2 text-sm text-gray-700">{{ choice.choice_label }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div id="installment-fields" class="mt-6 border p-4 rounded-md bg-gray-50" style="display:none;">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Installment Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {% for field in installment_form %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
                        {{ field|add_class:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm" }}
                        {% for error in field.errors %}<p class="text-sm text-red-600 mt-1">{{ error }}</p>{% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <h2 class="text-xl font-semibold text-gray-700 mb-3">Sale Items</h2>
        <table class="min-w-full divide-y divide-gray-200">
            <thead>
                <tr class="bg-gray-50">
                    <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                    <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                    <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                    <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                    <th class="py-2 px-3"></th>
                </tr>
            </thead>
            <tbody id="formset-container" class="bg-white divide-y divide-gray-200">
                {{ formset.management_form }}
                {% for form in formset %}
                <tr class="item-row">
                    {% for field in form.visible_fields %}
                    <td class="py-2 px-3 whitespace-nowrap text-sm text-gray-500">
                        {% if field.label != 'Unit price' %}
                            {{ field|add_class:"w-full border-gray-300 rounded-md text-sm" }}
                        {% else %}
                            <input type="text" value="{{ field.value|default:'' }}" readonly class="w-full border-gray-300 rounded-md text-sm bg-gray-100 price-field" data-name="{{ field.name }}">
                            <input type="hidden" name="{{ field.name }}" value="{{ field.value|default:'0' }}" class="real-price-input">
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td class="py-2 px-3 whitespace-nowrap text-sm text-gray-900 font-semibold subtotal-display">
                        $0.00
                    </td>
                    <td class="py-2 px-3 whitespace-nowrap">
                        {% if form.instance.pk %}{{ form.DELETE }}{% else %}<button type="button" class="text-red-600 hover:text-red-900 remove-item-btn">X</button>{% endif %}
                    </td>
                    {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="bg-gray-100">
                    <td colspan="3" class="px-6 py-3 text-right text-base font-bold text-gray-800">TOTAL:</td>
                    <td id="grand-total-display" class="px-6 py-3 text-left text-base font-bold text-gray-800">$0.00</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>

        <div class="mt-4 flex justify-between">
            <button type="button" id="add-item" class="bg-primary-blue hover:bg-blue-800 text-white py-2 px-4 rounded transition duration-150 text-sm">
                + Add Item
            </button>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition duration-150 font-semibold shadow-md">
                Complete Sale
            </button>
        </div>
    </form>
</div>

<script id="empty-form" type="text/template">
    {% for form in formset.empty_form %}
    <tr class="item-row">
        {% for field in form.visible_fields %}
        <td class="py-2 px-3 whitespace-nowrap text-sm text-gray-500">
            {% if field.label != 'Unit price' %}
                {{ field|add_class:"w-full border-gray-300 rounded-md text-sm" }}
            {% else %}
                <input type="text" value="" readonly class="w-full border-gray-300 rounded-md text-sm bg-gray-100 price-field">
                <input type="hidden" name="{{ field.name }}" value="0" class="real-price-input">
            {% endif %}
        </td>
        {% endfor %}
        <td class="py-2 px-3 whitespace-nowrap text-sm text-gray-900 font-semibold subtotal-display">
            $0.00
        </td>
        <td class="py-2 px-3 whitespace-nowrap">
            <button type="button" class="text-red-600 hover:text-red-900 remove-item-btn">X</button>
        </td>
        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
    </tr>
    {% endfor %}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('sale-form');
        const formsetContainer = document.getElementById('formset-container');
        const totalForms = document.querySelector('#id_{{ formset.prefix }}-TOTAL_FORMS');
        const emptyFormTemplate = document.getElementById('empty-form').innerHTML;
        const addItemButton = document.getElementById('add-item');
        const grandTotalDisplay = document.getElementById('grand-total-display');
        const installmentFields = document.getElementById('installment-fields');
        const paymentRadios = document.querySelectorAll('.payment-type-radio');
        const priceUrl = "";

        let formIdx = totalForms.value;

        // --- 1. Formset Management (Add/Remove) ---
        addItemButton.addEventListener('click', () => {
            const newRowHtml = emptyFormTemplate.replace(/__prefix__/g, formIdx);
            formsetContainer.insertAdjacentHTML('beforeend', newRowHtml);
            totalForms.value = ++formIdx;
        });

        formsetContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-item-btn')) {
                const row = e.target.closest('.item-row');
                // Use the CAN_DELETE checkbox logic for formsets
                const deleteInput = row.querySelector('input[name$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.checked = true;
                }
                row.style.display = 'none';
                calculateTotal();
            }
        });

        // --- 2. Dynamic Price Fetching and Calculation ---
        function updateItemPrice(row) {
            const productSelect = row.querySelector('[name$="-product"]');
            const quantityInput = row.querySelector('[name$="-quantity"]');
            const priceDisplay = row.querySelector('.price-field');
            const priceRealInput = row.querySelector('.real-price-input');
            const subtotalDisplay = row.querySelector('.subtotal-display');

            if (productSelect && productSelect.value) {
                // AJAX call to fetch price based on product ID
                fetch(priceUrl + `?product_id=${productSelect.value}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.price) {
                            const price = parseFloat(data.price);
                            const quantity = parseInt(quantityInput.value) || 0;
                            const subtotal = price * quantity;

                            priceDisplay.value = price.toFixed(2);
                            priceRealInput.value = price.toFixed(2); // Set hidden value for submission
                            subtotalDisplay.textContent = `$${subtotal.toFixed(2)}`;
                            calculateTotal();
                        } else {
                            // Reset if product not found/error
                            priceDisplay.value = '0.00';
                            priceRealInput.value = '0.00';
                            subtotalDisplay.textContent = '$0.00';
                            calculateTotal();
                        }
                    });
            } else {
                priceDisplay.value = '0.00';
                priceRealInput.value = '0.00';
                subtotalDisplay.textContent = '$0.00';
                calculateTotal();
            }
        }

        function calculateSubtotal(row) {
            const quantityInput = row.querySelector('[name$="-quantity"]');
            const priceRealInput = row.querySelector('.real-price-input');
            const subtotalDisplay = row.querySelector('.subtotal-display');

            const price = parseFloat(priceRealInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 0;
            const subtotal = price * quantity;
            
            subtotalDisplay.textContent = `$${subtotal.toFixed(2)}`;
            calculateTotal();
        }

        function calculateTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                // Only count rows that are visible and not marked for deletion
                const isDeleted = row.querySelector('input[name$="-DELETE"]') && row.querySelector('input[name$="-DELETE"]').checked;
                if (row.style.display !== 'none' && !isDeleted) {
                    const subtotalText = row.querySelector('.subtotal-display').textContent;
                    const subtotal = parseFloat(subtotalText.replace('$', '')) || 0;
                    grandTotal += subtotal;
                }
            });
            grandTotalDisplay.textContent = `$${grandTotal.toFixed(2)}`;
        }

        formsetContainer.addEventListener('change', (e) => {
            const row = e.target.closest('.item-row');
            if (e.target.matches('[name$="-product"]')) {
                updateItemPrice(row);
            } else if (e.target.matches('[name$="-quantity"]')) {
                calculateSubtotal(row);
            }
        });

        // --- 3. Installment Visibility Toggler ---
        function toggleInstallmentFields() {
            const selectedValue = document.querySelector('input[name="{{ sale_form.payment_type.name }}"]:checked')?.value;
            if (selectedValue === 'INST') {
                installmentFields.style.display = 'block';
            } else {
                installmentFields.style.display = 'none';
            }
        }

        paymentRadios.forEach(radio => {
            radio.addEventListener('change', toggleInstallmentFields);
        });

        // Initial setup for existing forms/state
        toggleInstallmentFields();
        calculateTotal(); 
        document.querySelectorAll('.item-row').forEach(row => calculateSubtotal(row));
    });
</script>
{% endblock content %}